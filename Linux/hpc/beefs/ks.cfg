#version=RHEL8
cdrom

# Idioma e teclado
lang en_US.UTF-8
keyboard us

# Fuso horário
timezone America/Sao_Paulo --isUtc

# Senha root
rootpw --plaintext redhat

# Rede via DHCP
network --bootproto=dhcp --onboot=on

# Segurança básica
firewall --disabled
selinux --disabled

# Bootloader
bootloader --location=mbr

# Particionamento automático (sem /home e swap)
zerombr
clearpart --all --initlabel
autopart --type=lvm --nohome --noswap

# Repositórios locais (ISO/CDROM)
repo --name="BaseOS" --baseurl=file:///run/install/repo/BaseOS
repo --name="AppStream" --baseurl=file:///run/install/repo/AppStream

# Pacotes
%packages
@^minimal-environment

# HPC básicos
environment-modules
nfs-utils
openssh-server
wget
vim

# Ferramentas de compilação
gcc
gcc-c++
make
kernel-devel
elfutils-libelf-devel
tuned

# MPI stack
openmpi
openmpi-devel

# Dell
device-mapper-multipath.x86_64
# sassist.noarch : Dell SupportAssist log collector
# sos
%end

# Pós-instalação
%post --log=/root/ks-post.log
echo ">>> Pós-instalação Kickstart iniciado" >> /root/ks.log

# Habilitar serviços essenciais
systemctl enable sshd
systemctl set-default multi-user.target

# Instalar IOR (benchmark HPC de I/O)
mkdir -p /opt/ior
cd /opt/ior
curl -L -o ior.tar.gz https://github.com/hpc/ior/releases/download/3.3.0/ior-3.3.0.tar.gz
tar xvf ior.tar.gz
cd ior-3.3.0

# Compilar com suporte a MPI
module load mpi/openmpi-x86_64 || true
./configure --prefix=/opt/ior CC=mpicc
make -j$(nproc)
make install

# Adicionar IOR ao PATH global
echo 'export PATH=/opt/ior/bin:$PATH' > /etc/profile.d/ior.sh
chmod +x /etc/profile.d/ior.sh

# Teste de instalação
/opt/ior/bin/ior --version >> /root/ior_installed.log 2>&1

echo ">>> Pós-instalação Kickstart finalizado" >> /root/ks.log
%end
