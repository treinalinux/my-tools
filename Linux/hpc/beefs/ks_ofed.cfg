#version=RHEL8
cdrom

# Idioma e teclado
lang en_US.UTF-8
keyboard us

# Fuso horário
timezone America/Sao_Paulo --isUtc

# Senha root
rootpw --plaintext redhat

# Rede via DHCP
network --bootproto=dhcp --onboot=on

# Segurança
firewall --disabled
selinux --disabled

# Bootloader
bootloader --location=mbr

# Particionamento automático
zerombr
clearpart --all --initlabel
autopart --type=lvm --nohome --noswap

# Repositórios locais (ISO/CDROM)
repo --name="BaseOS" --baseurl=file:///run/install/repo/BaseOS
repo --name="AppStream" --baseurl=file:///run/install/repo/AppStream

# Pacotes básicos + HPC
%packages
@^minimal-environment

# HPC essenciais
environment-modules
nfs-utils
openssh-server
wget
vim

# Build essentials
gcc
gcc-c++
make
kernel-devel
elfutils-libelf-devel
tuned

# MPI stack
openmpi
openmpi-devel
%end

# Pós-instalação: instalar MLNX OFED e IOR
%post --log=/root/ks-post.log
echo ">>> Pós-instalação Kickstart iniciado" >> /root/ks.log

# Serviços essenciais
systemctl enable sshd
systemctl set-default multi-user.target

##############################################
# Instalação do driver Mellanox OFED
##############################################
mkdir -p /opt/mlnx
cd /opt/mlnx

# Copiar o instalador do CDROM para /opt/mlnx
cp /run/install/repo/MLNX_OFED/MLNX_OFED_LINUX-5.8-1.1.2.1-rhel8.7-x86_64.tgz .

tar xvf MLNX_OFED_LINUX-5.8-1.1.2.1-rhel8.7-x86_64.tgz
cd MLNX_OFED_LINUX-5.8-1.1.2.1-rhel8.7-x86_64

# Instalação automática do OFED (sem prompt)
./mlnxofedinstall --force --add-kernel-support --without-dkms --skip-repo

# Configuração de serviços
/etc/init.d/openibd restart
systemctl enable openibd
systemctl enable rdma

##############################################
# Instalar IOR (benchmark de I/O com MPI)
##############################################
mkdir -p /opt/ior
cd /opt/ior
curl -L -o ior.tar.gz https://github.com/hpc/ior/releases/download/3.3.0/ior-3.3.0.tar.gz
tar xvf ior.tar.gz
cd ior-3.3.0

module load mpi/openmpi-x86_64 || true
./configure --prefix=/opt/ior CC=mpicc
make -j$(nproc)
make install

echo 'export PATH=/opt/ior/bin:$PATH' > /etc/profile.d/ior.sh
chmod +x /etc/profile.d/ior.sh

/opt/ior/bin/ior --version >> /root/ior_installed.log 2>&1

echo ">>> Pós-instalação finalizada (OFED + IOR)" >> /root/ks.log
%end
